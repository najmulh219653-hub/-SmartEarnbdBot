<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnQuick Mini App</title>
    <!-- Tailwind CSS ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Telegram Web App ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶´‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶•‡¶ø‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D1117; /* ‡¶°‡¶ø‡¶™ ‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° */
            color: #E5E7EB; /* ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü */
            margin: 0;
            padding: 0;
            overscroll-behavior-y: none;
        }
        /* ‡¶¨‡¶ü‡¶Æ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá */
        .container-main {
            /* ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® (64px) + ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° (64px) + ‡¶ü‡ßã‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶®‡ßç‡¶Ø ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶∏‡ßç‡¶•‡¶æ‡¶® */
            padding-bottom: 128px; 
            min-height: 100vh;
        }
        .nav-button:hover {
            color: #10B981;
        }
        .active-nav {
            color: #10B981; /* Emerald-500 */
        }
        /* ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ */
        .banner-ad-container {
            height: 64px; /* ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ */
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body>

    <!-- ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
    <div id="app" class="min-h-screen bg-[#0D1117] relative flex flex-col items-center">
        <!-- ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® -->
        <div id="loading-screen" class="absolute inset-0 bg-[#0D1117] flex flex-col items-center justify-center transition-opacity duration-300">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400"></div>
            <p class="mt-4 text-emerald-400">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        </div>
        
        <!-- ‡¶Æ‡ßÇ‡¶≤ UI (‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶•‡¶æ‡¶ï‡¶¨‡ßá) -->
        <div id="main-ui" class="w-full max-w-lg transition-opacity duration-300 opacity-0 hidden">
            
            <!-- ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶π‡ßá‡¶°‡¶æ‡¶∞: ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ -->
            <header class="sticky top-0 w-full p-4 bg-[#0D1117] border-b border-gray-800 z-10">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-sm text-gray-400">‡¶á‡¶â‡¶ú‡¶æ‡¶∞: <span id="user-name"></span></span>
                        <h1 class="text-2xl font-bold text-white flex items-center">
                            <i data-lucide="wallet" class="w-5 h-5 mr-2 text-emerald-400"></i>
                            <span id="current-points">0</span> <span class="text-sm ml-1 text-gray-400">‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</span>
                        </h1>
                    </div>
                    <button onclick="fetchUserData()" class="p-2 rounded-full text-emerald-400 hover:text-emerald-300 transition-colors bg-gray-800/50">
                        <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <!-- ‡¶™‡ßá‡¶ú ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ -->
            <main id="page-content" class="p-4 w-full container-main"></main>


            <!-- ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ (‡¶∏‡¶¨ ‡¶™‡ßá‡¶ú‡ßá ‡¶∂‡ßã ‡¶ï‡¶∞‡¶¨‡ßá) -->
            <!-- ‡¶è‡¶ü‡¶ø ‡¶¨‡¶ü‡¶Æ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá -->
            <div class="banner-ad-container fixed bottom-16 left-0 right-0 z-20 flex justify-center w-full max-w-lg mx-auto bg-gray-900 border-t border-gray-700 shadow-xl">
                <div class="flex items-center justify-center w-full h-full text-center text-sm font-semibold text-yellow-400 bg-gray-800">
                    <!-- ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡ßã‡¶° ‡¶¨‡¶æ ‡¶á‡¶Æ‡ßá‡¶ú ‡¶¨‡¶∏‡¶æ‡¶® -->
                    <i data-lucide="megaphone" class="w-5 h-5 mr-2"></i> ‡¶∏‡ßç‡¶™‡¶®‡¶∏‡¶∞‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°
                </div>
            </div>


            <!-- ‡¶´‡ßç‡¶≤‡ßã‡¶ü‡¶ø‡¶Ç ‡¶¨‡¶ü‡¶Æ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® (‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá) -->
            <footer class="fixed bottom-0 left-0 right-0 w-full max-w-lg mx-auto bg-[#1A202C] border-t border-gray-700 shadow-xl z-30 rounded-t-xl">
                <div class="flex justify-around items-center h-16">
                    <button class="nav-button flex flex-col items-center p-2 transition-colors text-gray-400" onclick="renderPage('Home')" id="nav-Home">
                        <i data-lucide="home" class="w-6 h-6"></i>
                        <span class="text-xs">‡¶π‡ßã‡¶Æ</span>
                    </button>
                    <button class="nav-button flex flex-col items-center p-2 transition-colors text-gray-400" onclick="renderPage('Referral')" id="nav-Referral">
                        <i data-lucide="users" class="w-6 h-6"></i>
                        <span class="text-xs">‡¶∞‡ßá‡¶´‡¶æ‡¶∞</span>
                    </button>
                    <button class="nav-button flex flex-col items-center p-2 transition-colors text-gray-400" onclick="renderPage('Withdraw')" id="nav-Withdraw">
                        <i data-lucide="send" class="w-6 h-6"></i>
                        <span class="text-xs">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞</span>
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <!-- ‡¶ü‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
    <!-- ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶è‡¶¨‡¶Ç ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá -->
    <div id="toast-container" class="fixed bottom-36 right-4 left-4 z-50 flex flex-col items-center pointer-events-none"></div>


<script>
    // *******************************************************************
    // ** Telegram Mini App & Backend API Configuration         **
    // *******************************************************************

    // API ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ URL ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
    const API_URL = "https://smartearnbdbot.onrender.com/api"; 
    
    // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü
    let appState = {
        telegramId: null,
        username: "Guest",
        points: 0,
        referralCode: "Loading...",
        referralCount: 0,
        currentPage: 'Home',
        isLoading: true,
    };

    // *******************************************************************
    // ** Helper Functions                        **
    // *******************************************************************

    /**
     * @function showToast
     * Shows a floating notification toast.
     * @param {string} message - The message to display.
     * @param {string} type - 'success', 'error', or 'info'.
     */
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        let bgColor = 'bg-gray-700';
        if (type === 'success') bgColor = 'bg-emerald-600';
        if (type === 'error') bgColor = 'bg-red-600';

        const toast = document.createElement('div');
        toast.className = `p-3 mb-3 rounded-lg shadow-lg text-white ${bgColor} transition-opacity duration-300`;
        toast.textContent = message;
        container.appendChild(toast);

        // Transition out
        setTimeout(() => {
            toast.style.opacity = 0;
            setTimeout(() => toast.remove(), 300);
        }, 3000);

        // Haptic feedback (Mobile only)
        if (window.Telegram.WebApp.HapticFeedback) {
            if (type === 'success') window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            if (type === 'error') window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
    }

    /**
     * @function fetchWithRetry
     * Fetches data with exponential backoff for resilience.
     */
    async function fetchWithRetry(url, options, retries = 3) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    // If server returns 4xx or 5xx, throw to enter catch block
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                if (i === retries - 1) throw error; 
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }


    // *******************************************************************
    // ** API Calls                              **
    // *******************************************************************

    /**
     * @function fetchUserData
     * Retrieves user points and referral data from the backend.
     */
    async function fetchUserData() {
        if (!appState.telegramId) {
            // ‡¶Ø‡¶¶‡¶ø ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ
            document.getElementById('current-points').textContent = 'N/A';
            return;
        }

        try {
            // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            document.getElementById('current-points').textContent = '...';
            
            // ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶™‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
            const urlParams = new URLSearchParams(window.Telegram.WebApp.initData);
            // 'start' ‡¶™‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            const startParam = urlParams.get('start'); 
            
            let fetchUrl = `${API_URL}/user-data?id=${appState.telegramId}`;
            if (startParam) {
                fetchUrl += `&referrer=${startParam}`; 
            }

            const data = await fetchWithRetry(fetchUrl, { method: 'GET' });
            
            if (data.success) {
                appState.points = data.points;
                appState.referralCode = data.referral_code;
                appState.referralCount = data.referral_count;
                
                // UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                document.getElementById('current-points').textContent = data.points.toLocaleString('bn-BD');
                // ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶™‡ßá‡¶ú‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                renderPage(appState.currentPage); 
            } else {
                showToast(data.message || "‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§", 'error');
            }
        } catch (error) {
            console.error("User data fetch error:", error);
            showToast("‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ (Database/Connection Error)", 'error');
        } finally {
            // ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡ßá ‡¶∏‡¶¨ Lucide ‡¶Ü‡¶á‡¶ï‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
            lucide.createIcons();
        }
    }

    /**
     * @function addPoints
     * Simulates watching an ad and adding points.
     */
    async function addPoints() {
        if (!appState.telegramId) return showToast("‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßü‡•§", 'error');

        const earnButton = document.getElementById('earn-button');
        
        // ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú‡ßá ‡¶•‡¶æ‡¶ï‡¶æ‡¶Ø‡¶º, ‡¶è‡¶ü‡¶ø ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶
        if (!earnButton) return; 

        earnButton.disabled = true;
        earnButton.innerHTML = `
            <i data-lucide="loader" class="w-6 h-6 animate-spin mr-2"></i> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ö‡¶≤‡¶õ‡ßá...
        `;
        lucide.createIcons();

        // 3 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶∂‡¶®
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        try {
            const response = await fetchWithRetry(`${API_URL}/add-points`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    telegramId: appState.telegramId, 
                    points: 5 // ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡ßá 5 ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü 
                }),
            });

            if (response.success) {
                appState.points = response.new_points;
                document.getElementById('current-points').textContent = response.new_points.toLocaleString('bn-BD');
                showToast(response.message, 'success');
            } else {
                showToast(response.message || "‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§", 'error');
            }

        } catch (error) {
            console.error("Add points error:", error);
            showToast("‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§", 'error');
        } finally {
            // ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶´‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶®‡¶æ
            earnButton.innerHTML = `
                <i data-lucide="monitor" class="w-6 h-6 mr-2"></i> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶ì ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®
            `;
            earnButton.disabled = false;
            lucide.createIcons();
        }
    }

    /**
     * @function sendWithdrawRequest
     * Submits a withdrawal request.
     */
    async function sendWithdrawRequest(event) {
        event.preventDefault();
        
        const points = parseInt(document.getElementById('withdraw-points').value);
        const method = document.getElementById('payment-method').value;
        const address = document.getElementById('payment-address').value;
        const submitButton = document.getElementById('withdraw-submit');

        if (!points || !method || !address || points < 1000) {
            return showToast("‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßß‡ß¶‡ß¶‡ß¶ ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ï‡¶≤ ‡¶ò‡¶∞ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", 'error');
        }

        if (points > appState.points) {
            return showToast(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶õ‡ßá: ${appState.points.toLocaleString('bn-BD')}`, 'error');
        }

        submitButton.disabled = true;
        submitButton.textContent = '‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

        try {
            const response = await fetchWithRetry(`${API_URL}/withdraw`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    telegramId: appState.telegramId, 
                    points, 
                    paymentMethod: method, 
                    paymentAddress: address 
                }),
            });

            if (response.success) {
                appState.points = response.new_points;
                document.getElementById('current-points').textContent = response.new_points.toLocaleString('bn-BD');
                document.getElementById('withdraw-form').reset();
                showToast(response.message, 'success');
                // ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá ‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                renderPage('Withdraw'); 
            } else {
                showToast(response.message || "‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§", 'error');
            }
        } catch (error) {
            console.error("Withdraw error:", error);
            showToast("‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§", 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = '‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®';
        }
    }

    // *******************************************************************
    // ** Rendering                           **
    // *******************************************************************

    /**
     * @function renderHomePage
     * Renders the Home page content.
     */
    function renderHomePage() {
        return `
            <div class="space-y-6">
                <!-- ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü ‡¶ï‡¶æ‡¶∞‡ßç‡¶° -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl transition-all duration-300 transform hover:scale-[1.02] border border-emerald-600/30">
                    <div class="flex items-center justify-between">
                        <span class="text-lg font-semibold text-white">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</span>
                        <i data-lucide="trending-up" class="w-6 h-6 text-emerald-400"></i>
                    </div>
                    <p class="text-4xl font-extrabold text-emerald-400 mt-2">
                        ${appState.points.toLocaleString('bn-BD')} <span class="text-base text-gray-400">‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</span>
                    </p>
                </div>
                
                <!-- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ü‡¶® (Home Page Only) -->
                <button id="earn-button" onclick="addPoints()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-6 rounded-xl transition-colors flex items-center justify-center text-lg shadow-emerald-700/50">
                    <i data-lucide="monitor" class="w-6 h-6 mr-2"></i> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶ì ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>


                <!-- ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶§‡¶•‡ßç‡¶Ø -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800 p-4 rounded-xl flex flex-col items-start shadow-lg">
                        <i data-lucide="gift" class="w-6 h-6 text-yellow-400 mb-2"></i>
                        <span class="text-sm text-gray-400">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏</span>
                        <span class="text-lg font-bold text-white">‡ß®‡ß´‡ß¶ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</span>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl flex flex-col items-start shadow-lg">
                        <i data-lucide="badge-check" class="w-6 h-6 text-blue-400 mb-2"></i>
                        <span class="text-sm text-gray-400">‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞</span>
                        <span class="text-lg font-bold text-white">‡ßß,‡ß¶‡ß¶‡ß¶ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</span>
                    </div>
                </div>

                <!-- ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ó‡¶æ‡¶á‡¶°‡ßá‡¶®‡ßç‡¶∏ -->
                <div class="bg-gray-900 p-4 rounded-xl border border-gray-700">
                    <h3 class="text-xl font-semibold text-emerald-400 mb-2">‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ó‡¶æ‡¶á‡¶°</h3>
                    <ul class="text-gray-400 space-y-2 text-sm list-disc list-inside">
                        <li>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¨‡¶æ‡¶∞ "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡ß´ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§</li>
                        <li>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá ‡¶ï‡ßá‡¶â ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡ß®‡ß´‡ß¶ ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§</li>
                        <li>‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§</li>
                    </ul>
                </div>
            </div>
        `;
    }

    /**
     * @function renderReferralPage
     * Renders the Referral page content.
     */
    function renderReferralPage() {
        // Mini App URL ‡¶è‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
        let startLink = "";
        const botUsername = "EarnQuick_Official"; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶ü‡ßá‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        
        if (appState.referralCode && botUsername) {
            // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá bot_username ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Telegram Bot username ‡¶π‡¶¨‡ßá
            startLink = `https://t.me/${botUsername}?start=${appState.referralCode}`;
        }

        const shareText = `üí∞ EarnQuick Mini App ‡¶è ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡ßá ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®! ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶ø‡¶ì ‡ß®‡ß´‡ß¶ ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§ ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®: ${startLink || "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Mini App ‡¶è‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶¶‡¶ø‡¶®"} (‡¶ï‡ßã‡¶°: ${appState.referralCode})`;
        const shareLink = `tg://msg?text=${encodeURIComponent(shareText)}`;

        return `
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-white border-b border-gray-700 pb-2">‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ì ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-blue-600/30">
                    <p class="text-sm text-gray-400 mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶â‡¶®‡¶ø‡¶ï ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶°:</p>
                    <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg border border-emerald-600/50">
                        <span id="referral-code-display" class="font-mono text-xl text-emerald-400 select-all break-all">${appState.referralCode}</span>
                        <button onclick="copyToClipboard('${appState.referralCode}')" class="ml-3 text-emerald-400 hover:text-emerald-300 transition-colors flex-shrink-0">
                            <i data-lucide="copy" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <p class="text-lg font-semibold text-white mb-3 flex items-center">
                        <i data-lucide="users" class="w-5 h-5 mr-2 text-blue-400"></i> ‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤
                    </p>
                    <p id="referral-count-display" class="text-4xl font-extrabold text-blue-400">${appState.referralCount.toLocaleString('bn-BD')}</p>
                    <p class="text-sm text-gray-400 mt-3">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶Ç‡¶ï: <a href="${startLink}" class="text-emerald-400 break-all hover:underline">${startLink}</a></p>
                </div>

                <a href="${shareLink}" class="block w-full text-center bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-blue-700/50 flex items-center justify-center">
                    <i data-lucide="share2" class="w-5 h-5 mr-2"></i> ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                </a>
            </div>
        `;
    }

    /**
     * @function renderWithdrawPage
     * Renders the Withdraw page content.
     */
    function renderWithdrawPage() {
        return `
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-white border-b border-gray-700 pb-2">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-600/30">
                    <p class="text-lg font-semibold text-white mb-3">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: <span class="text-emerald-400">${appState.points.toLocaleString('bn-BD')}</span> ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</p>
                    <p class="text-sm text-yellow-400 mb-4">‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞: ‡ßß,‡ß¶‡ß¶‡ß¶ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü (‡ßß‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶∏‡¶Æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø)</p>

                    <form id="withdraw-form" onsubmit="sendWithdrawRequest(event)" class="space-y-4">
                        <div>
                            <label for="withdraw-points" class="block text-sm font-medium text-gray-300 mb-1">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</label>
                            <input type="number" id="withdraw-points" required min="1000" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-emerald-500 focus:ring focus:ring-emerald-500/50" placeholder="‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßß‡ß¶‡ß¶‡ß¶ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü">
                        </div>
                        
                        <div>
                            <label for="payment-method" class="block text-sm font-medium text-gray-300 mb-1">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°</label>
                            <select id="payment-method" required class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-emerald-500 focus:ring focus:ring-emerald-500/50">
                                <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                                <option value="Bkash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
                                <option value="Nagad">‡¶®‡¶ó‡¶¶</option>
                                <option value="Rocket">‡¶∞‡¶ï‡ßá‡¶ü</option>
                                <option value="Recharge">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∞‡¶ø‡¶ö‡¶æ‡¶∞‡ßç‡¶ú</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="payment-address" class="block text-sm font-medium text-gray-300 mb-1">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ (‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤/‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞)</label>
                            <input type="text" id="payment-address" required class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-emerald-500 focus:ring focus:ring-emerald-500/50" placeholder="01XXXXXXXXX">
                        </div>

                        <button type="submit" id="withdraw-submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-emerald-700/50">
                            ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®
                        </button>
                    </form>
                </div>
            </div>
        `;
    }

    /**
     * @function renderPage
     * Main rendering function to switch between pages.
     */
    function renderPage(pageName) {
        if (appState.isLoading) return;

        appState.currentPage = pageName;
        const contentArea = document.getElementById('page-content');
        let htmlContent = '';
        
        // ‡¶∏‡¶¨ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶•‡ßá‡¶ï‡ßá active ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡¶∞‡¶æ‡¶®
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active-nav'));
        // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ü‡¶®‡ßá active ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
        const activeNav = document.getElementById(`nav-${pageName}`);
        if (activeNav) activeNav.classList.add('active-nav');


        switch (pageName) {
            case 'Home':
                htmlContent = renderHomePage();
                break;
            case 'Referral':
                htmlContent = renderReferralPage();
                break;
            case 'Withdraw':
                htmlContent = renderWithdrawPage();
                break;
            default:
                htmlContent = `<p class="text-center text-red-500">‡¶™‡ßá‡¶ú‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>`;
        }
        
        contentArea.innerHTML = htmlContent;
        // ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶™‡¶∞ Lucide ‡¶Ü‡¶á‡¶ï‡¶®‡¶ó‡ßÅ‡¶≤‡¶ø‡¶ï‡ßá ‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá
        lucide.createIcons();
    }

    /**
     * @function copyToClipboard
     * Copies text to the clipboard and shows a toast.
     */
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast("‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!", 'success');
        }).catch(err => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast("‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!", 'success');
        });
    }

    /**
     * @function initApp
     * Initializes the Telegram Mini App and loads user data.
     */
    async function initApp() {
        try {
            // 1. Telegram Web App ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ 
            if (typeof window.Telegram === 'undefined' || typeof window.Telegram.WebApp === 'undefined') {
                throw new Error("Telegram WebApp object is not available. Are you running this outside a Telegram client?");
            }

            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand(); // ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶æ
            
            // UI ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶•‡¶ø‡¶Æ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ
            document.documentElement.style.backgroundColor = window.Telegram.WebApp.themeParams.bg_color || '#0D1117';
            document.body.style.backgroundColor = window.Telegram.WebApp.themeParams.bg_color || '#0D1117';


            const user = window.Telegram.WebApp.initDataUnsafe.user;
            
            // 2. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
            if (!user || !user.id) {
                // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶≤‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                document.getElementById('loading-screen').classList.remove('hidden');
                document.getElementById('loading-screen').style.opacity = '1';
                document.getElementById('loading-screen').innerHTML = `
                    <div class="p-6 text-center max-w-sm mx-auto bg-gray-800 rounded-xl shadow-2xl">
                        <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
                        <h2 class="text-xl font-bold text-white mb-2">‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§!</h2>
                        <p class="text-red-400 mb-4">‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>
                        <p class="text-gray-300 text-sm">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¨‡¶ü‡ßá‡¶∞ **Inline Keyboard** ‡¶¨‡¶æ **Web App** ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶è‡¶ü‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§</p>
                        <button onclick="window.Telegram.WebApp.close()" class="mt-4 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                           ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return; // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶á ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
            }

            // 3. ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            appState.telegramId = user.id.toString(); // API ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ID ‡¶ï‡ßá ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç ‡¶è ‡¶∞‡¶æ‡¶ñ‡¶æ
            appState.username = user.username || user.first_name || '‡¶á‡¶â‡¶ú‡¶æ‡¶∞';
            
            document.getElementById('user-name').textContent = appState.username;

            // 4. ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            await fetchUserData();

            // 5. ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶∂‡ßá‡¶∑, UI ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            appState.isLoading = false;
            document.getElementById('loading-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-ui').classList.remove('hidden');
                document.getElementById('main-ui').style.opacity = '1';
                renderPage('Home');
            }, 300); 

        } catch (e) {
            console.error("Initialization error:", e);
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('loading-screen').style.opacity = '1';
            document.getElementById('loading-screen').innerHTML = `
                <div class="p-6 text-center max-w-sm mx-auto bg-gray-800 rounded-xl shadow-2xl">
                    <i data-lucide="wifi-off" class="w-12 h-12 text-yellow-500 mx-auto mb-4"></i>
                    <h2 class="text-xl font-bold text-white mb-2">‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</h2>
                    <p class="text-gray-300 text-sm">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶æ Render ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    <p class="text-red-400 text-xs mt-2">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§: ${e.message}</p>
                </div>
            `;
            lucide.createIcons();
        }
    }

    window.addEventListener('load', initApp);
</script>
</body>
    </html>
