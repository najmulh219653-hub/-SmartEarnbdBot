<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnQuick_Official MiniApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®: ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶•‡¶ø‡¶Æ
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#10b981',
                        'secondary-dark': '#1f2937',
                        'bg-dark': '#0f172a',
                        'error-red': '#ef4444',
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* bg-dark */
            color: white;
            padding: 0;
            margin: 0;
            user-select: none;
        }
        .card {
            background-color: #1f2937; /* secondary-dark */
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            padding: 16px;
        }
        .btn-primary {
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .text-error {
            color: #ef4444; /* error-red */
        }
        /* Marquee/Running Headline Style */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            background-color: #0d9488; /* Teal-700 for notice */
            padding: 6px 0;
        }
        .marquee-content {
            display: inline-block;
            animation: marquee 15s linear infinite;
        }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4" onclick="hideMessage()">
        <div class="card p-6 w-full max-w-sm text-center" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-xl font-bold mb-3"></h3>
            <p id="modal-body" class="text-gray-300 mb-4"></p>
            <button onclick="hideMessage()" class="mt-2 w-full py-2 bg-primary-green rounded-lg font-semibold hover:bg-opacity-80 transition duration-150">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <div id="withdraw-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4" onclick="toggleWithdrawModal(false)">
        <div class="card p-6 w-full max-w-sm" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-primary-green">‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            
            <label for="withdraw-points" class="block text-sm font-medium text-gray-400 mb-1">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü (‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ 5,000)</label>
            <input type="number" id="withdraw-points" placeholder="‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ" class="w-full p-3 rounded-lg bg-secondary-dark border border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-green mb-4 text-white" value="5000" min="5000">

            <label for="withdraw-account" class="block text-sm font-medium text-gray-400 mb-1">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü (‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂/‡¶®‡¶ó‡¶¶ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞)</label>
            <input type="text" id="withdraw-account" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" class="w-full p-3 rounded-lg bg-secondary-dark border border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-green mb-6 text-white">

            <button id="confirm-withdraw-btn" onclick="requestWithdrawal()" class="w-full py-3 text-lg font-bold bg-primary-green rounded-xl btn-primary disabled:opacity-50">
                ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®
            </button>
            <button onclick="toggleWithdrawModal(false)" class="w-full py-2 mt-2 text-sm text-gray-400 hover:text-white transition">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        </div>
    </div>
    
    <header class="text-center">
        <h1 class="text-2xl font-bold text-gray-100 py-3">EarnQuick_Official</h1>
    </header>

    <div id="running-notice-container" class="marquee-container text-white text-sm font-medium mb-4">
        <p id="running-notice" class="marquee-content px-4"></p>
    </div>

    <div id="main-app-view" class="p-4 space-y-6 max-w-lg mx-auto">
        
        <a id="banner-link-a" href="#" target="_blank" class="block rounded-xl overflow-hidden shadow-xl">
            <img id="banner-ad-img" src="https://placehold.co/480x80/22c55e/ffffff?text=Loading+Ad" alt="Banner Advertisement" class="w-full h-auto object-cover">
        </a>
        
        <div class="card p-4">
            <div class="flex items-center justify-between mb-4">
                <p class="text-sm text-gray-400">‡¶á‡¶â‡¶ú‡¶æ‡¶∞: <span id="username-display" class="font-semibold text-white">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...</span></p>
                <div class="flex items-center space-x-3">
                    <button id="admin-btn" onclick="switchView('admin')" class="hidden text-red-400 hover:text-red-500 transition font-bold text-sm bg-red-900/50 px-2 py-1 rounded-full">
                        Admin
                    </button>
                    <button onclick="loadUserData(true)" class="text-primary-green hover:text-green-400 transition">
                        <svg id="reload-icon" class="w-6 h-6 transform transition duration-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.836 2.582a4.99 4.99 0 00-3.328-3.328m0 0a4.99 4.99 0 00-3.328-3.328M12 21a9 9 0 00-8.23-5.26M12 3a9 9 0 00-8.23 5.26" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="text-center bg-gray-700/50 p-4 rounded-lg">
                <p class="text-lg text-gray-300">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</p>
                <p id="points-display" class="text-4xl font-extrabold text-primary-green mt-1">...</p>
            </div>
        </div>

        <button id="add-points-btn" onclick="addPoints()" class="w-full py-3 text-lg font-bold bg-primary-green rounded-xl btn-primary shadow-lg shadow-green-900/50 flex items-center justify-center space-x-2 disabled:opacity-50" disabled>
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1v-3" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11V5M17 16H7" />
            </svg>
            <span>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶ì ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶® (‡ßß‡ß¶ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü)</span>
        </button>

        <div class="grid grid-cols-2 gap-4">
            <div class="card text-center">
                <p class="text-gray-300 font-semibold text-sm">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏</p>
                <p class="text-primary-green text-xl font-bold mt-1">‡ß®‡ß´‡ß¶ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</p>
            </div>
            <div class="card text-center">
                <p class="text-gray-300 font-semibold text-sm">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</p>
                <p id="referral-count-display" class="text-primary-green text-xl font-bold mt-1">...</p>
            </div>
        </div>
        
        <div class="card text-center p-3">
            <p class="text-gray-300 font-semibold text-sm mb-2">‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞: <span class="text-yellow-400 font-bold">‡ß´,‡ß¶‡ß¶‡ß¶ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</span></p>
            <button onclick="toggleWithdrawModal(true)" id="withdraw-btn" class="w-full py-3 font-bold bg-blue-500 rounded-lg hover:bg-blue-600 transition btn-primary disabled:opacity-50" disabled>
                ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        </div>

    </div>
    
    <div id="admin-view" class="hidden p-4 space-y-6 max-w-2xl mx-auto">
        <div class="flex items-center justify-between card p-3">
            <h2 class="text-2xl font-bold text-red-400">üî• Admin Panel</h2>
            <button onclick="switchView('main')" class="text-gray-400 hover:text-white transition">‚Üê ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
        </div>
        
        <div class="card">
            <h3 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Pending Withdrawals (<span id="pending-count">0</span>)</h3>
            <div id="withdrawal-list" class="space-y-3">
                <p id="no-withdrawals" class="text-gray-500 text-center py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</p>
                </div>
            <button onclick="loadWithdrawals()" class="mt-4 w-full py-2 text-sm bg-gray-600/50 rounded-lg hover:bg-gray-600 transition">Reload Withdrawals</button>
        </div>
        
    </div>

    
    <script>
        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶á‡¶â‡¶Ü‡¶∞‡¶è‡¶≤ (Render/Localhost)
        const BASE_URL = window.location.origin;
        const MIN_WITHDRAWAL = 5000;
        const POINTS_PER_AD = 10;
        let CURRENT_VIEW = 'main';

        // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶Æ‡¶ø‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ
        let TELEGRAM_ID = new URLSearchParams(window.location.search).get('id');
        let TELEGRAM_USERNAME = new URLSearchParams(window.location.search).get('username') || 'GuestUser';
        let IS_ADMIN = false;

        // ‡¶Ø‡¶¶‡¶ø Telegram ID ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º, ‡¶§‡¶¨‡ßá ‡¶°‡¶æ‡¶Æ‡¶ø ID ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá (‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
        if (!TELEGRAM_ID) {
            console.warn('Telegram ID not found. Using DUMMY ID for dev.');
            TELEGRAM_ID = '123456789'; 
        }

        let CURRENT_POINTS = 0; 

        // DOM ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶ó‡ßÅ‡¶≤‡ßã
        const pointsDisplay = document.getElementById('points-display');
        const usernameDisplay = document.getElementById('username-display');
        const adminBtn = document.getElementById('admin-btn');
        const mainAppView = document.getElementById('main-app-view');
        const adminView = document.getElementById('admin-view');
        const reloadIcon = document.getElementById('reload-icon');
        const bannerAdImg = document.getElementById('banner-ad-img');
        const bannerLinkA = document.getElementById('banner-link-a');
        const runningNotice = document.getElementById('running-notice');
        const withdrawalList = document.getElementById('withdrawal-list');
        const pendingCount = document.getElementById('pending-count');
        const noWithdrawals = document.getElementById('no-withdrawals');

        // ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
        function showMessage(title, body, isError = false) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('modal-title').classList.toggle('text-error', isError);
            document.getElementById('modal-title').classList.toggle('text-primary-green', !isError);
            document.getElementById('message-modal').classList.remove('hidden');
        }

        function hideMessage() {
            document.getElementById('message-modal').classList.add('hidden');
        }

        // ‡¶≠‡¶ø‡¶â ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡¶æ
        function switchView(view) {
            CURRENT_VIEW = view;
            if (view === 'admin') {
                if (!IS_ADMIN) {
                    showMessage("Access Denied", "‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®, ‡¶§‡¶æ‡¶á ‡¶è‡¶á ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§", true);
                    return;
                }
                mainAppView.classList.add('hidden');
                adminView.classList.remove('hidden');
                loadWithdrawals();
            } else {
                adminView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                loadUserData(false); // ‡¶Æ‡ßá‡¶á‡¶® ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶è‡¶∏‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            }
        }
        
        // ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        async function loadAppConfig() {
            try {
                const response = await fetch(`${BASE_URL}/api/config`);
                const data = await response.json();
                
                if (data.success && data.config) {
                    const config = data.config;
                    
                    // ‡¶∞‡¶æ‡¶®‡¶ø‡¶Ç ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                    runningNotice.textContent = config.running_notice || '‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶®‡ßá‡¶á‡•§';
                    
                    // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                    bannerAdImg.src = config.banner_ad_url || 'https://placehold.co/480x80/6b7280/ffffff?text=Ad+Not+Configured';
                    bannerLinkA.href = config.banner_link || '#';
                }
            } catch (error) {
                console.error('Failed to load app config:', error);
                // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                runningNotice.textContent = '‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§ ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§';
            }
        }

        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        async function loadUserData(showLoading = true) {
            if (showLoading) {
                usernameDisplay.textContent = "‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...";
                pointsDisplay.textContent = "...";
                reloadIcon.classList.add('animate-spin'); 
                adminBtn.classList.add('hidden');
            }

            try {
                const response = await fetch(`${BASE_URL}/api/user_data?id=${TELEGRAM_ID}&username=${TELEGRAM_USERNAME}`);
                const data = await response.json();

                if (data.success) {
                    CURRENT_POINTS = data.user.total_points || 0;
                    IS_ADMIN = data.user.is_admin; // ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
                    
                    usernameDisplay.textContent = data.user.username;
                    pointsDisplay.textContent = CURRENT_POINTS;
                    document.getElementById('referral-count-display').textContent = data.user.referral_count || 0;
                    
                    // ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                    document.getElementById('add-points-btn').disabled = false;
                    document.getElementById('withdraw-btn').disabled = (CURRENT_POINTS < MIN_WITHDRAWAL);
                    
                    // ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                    if (IS_ADMIN) {
                        adminBtn.classList.remove('hidden');
                    }
                    
                } else {
                    usernameDisplay.textContent = "‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®";
                    pointsDisplay.textContent = "ERROR";
                    pointsDisplay.classList.add('text-error');
                    showMessage("‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", data.message || "‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§", true);
                }

            } catch (error) {
                console.error('Fetch error during user data load:', error);
                usernameDisplay.textContent = "‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®";
                pointsDisplay.textContent = "ERROR";
                pointsDisplay.classList.add('text-error');
                // ‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø
                showMessage("‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", true);
            } finally {
                reloadIcon.classList.remove('animate-spin'); 
            }
        }

        // ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (Number() ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§)
        async function addPoints() {
            const addPointsBtn = document.getElementById('add-points-btn');
            
            addPointsBtn.disabled = true;
            addPointsBtn.innerHTML = '<span class="animate-pulse">‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>';

            try {
                const response = await fetch(`${BASE_URL}/api/add_points`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        telegramId: TELEGRAM_ID, 
                        points: Number(POINTS_PER_AD) // üí° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ‡¶è‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    CURRENT_POINTS = data.newPoints;
                    pointsDisplay.textContent = CURRENT_POINTS;
                    document.getElementById('withdraw-btn').disabled = (CURRENT_POINTS < MIN_WITHDRAWAL);
                    showMessage("‡¶∏‡¶´‡¶≤!", `‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶™‡¶®‡¶ø ${POINTS_PER_AD} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§`, false);
                } else {
                    // ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∏‡¶æ data.message ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶ú‡¶æ‡¶®‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                    showMessage("‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", data.message || "‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡¶∞‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", true);
                }

            } catch (error) {
                console.error('Add points fetch error:', error);
                showMessage("‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡•§", true);
            } finally {
                addPointsBtn.disabled = false;
                addPointsBtn.innerHTML = `<svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1v-3" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11V5M17 16H7" />
                                        </svg>
                                        <span>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶ì ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶® (${POINTS_PER_AD} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü)</span>`;
            }
        }
        
        // ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® 
        async function requestWithdrawal() {
            const points = parseInt(document.getElementById('withdraw-points').value);
            const account = document.getElementById('withdraw-account').value.trim();

            if (points < MIN_WITHDRAWAL || isNaN(points) || account === '') {
                showMessage("‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡ß´,‡ß¶‡ß¶‡ß¶ ‡¶¨‡¶æ ‡¶§‡¶æ‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§", true);
                return;
            }

            if (points > CURRENT_POINTS) {
                 showMessage("‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶Æ", "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§", true);
                 return;
            }
            
            const confirmWithdrawBtn = document.getElementById('confirm-withdraw-btn');
            confirmWithdrawBtn.disabled = true;
            confirmWithdrawBtn.innerHTML = '<span class="animate-pulse">‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>';

            try {
                const response = await fetch(`${BASE_URL}/api/request_withdraw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        telegramId: TELEGRAM_ID, 
                        points: points,
                        account: account
                    }),
                });

                const data = await response.json();
                document.getElementById('withdraw-modal').classList.add('hidden');

                if (data.success) {
                    CURRENT_POINTS = data.newPoints;
                    pointsDisplay.textContent = CURRENT_POINTS;
                    document.getElementById('withdraw-btn').disabled = (CURRENT_POINTS < MIN_WITHDRAWAL);
                    showMessage("‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤!", `‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${points} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, false);
                } else {
                    showMessage("‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", data.message || "‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§", true);
                }

            } catch (error) {
                console.error('Withdrawal fetch error:', error);
                document.getElementById('withdraw-modal').classList.add('hidden');
                showMessage("‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡•§", true);
            } finally {
                confirmWithdrawBtn.disabled = false;
                confirmWithdrawBtn.textContent = '‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®';
            }
        }
        
        // ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶ü‡¶ó‡¶≤ ‡¶ï‡¶∞‡¶æ
        function toggleWithdrawModal(show) {
            const modal = document.getElementById('withdraw-modal');
            if (show) {
                if (CURRENT_POINTS < MIN_WITHDRAWAL) {
                    showMessage("‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶Ö‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨", `‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ${MIN_WITHDRAWAL} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§`, true);
                    return;
                }
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }


        // ===============================================
        // ADMIN PANEL LOGIC 
        // ===============================================

        // ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
        async function loadWithdrawals() {
            withdrawalList.innerHTML = '<p class="text-center text-gray-500 py-4"><span class="animate-spin mr-2">üîÑ</span> ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
            noWithdrawals.classList.add('hidden');

            try {
                const response = await fetch(`${BASE_URL}/api/admin/withdrawals?id=${TELEGRAM_ID}`);
                const data = await response.json();

                if (data.success) {
                    renderWithdrawals(data.withdrawals);
                } else {
                    showMessage("Admin Error", data.message || "‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", true);
                    withdrawalList.innerHTML = '<p class="text-center text-error py-4">‚ùå ‡¶≤‡ßã‡¶° ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§</p>';
                }
            } catch (error) {
                console.error('Admin fetch error:', error);
                showMessage("‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡•§", true);
                withdrawalList.innerHTML = '<p class="text-center text-error py-4">‚ùå ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡•§</p>';
            }
        }
        
        // ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        function renderWithdrawals(withdrawals) {
            withdrawalList.innerHTML = '';
            pendingCount.textContent = withdrawals.length;

            if (withdrawals.length === 0) {
                noWithdrawals.classList.remove('hidden');
                return;
            }
            noWithdrawals.classList.add('hidden');

            withdrawals.forEach(req => {
                const details = JSON.parse(req.payment_details);
                const item = document.createElement('div');
                item.className = 'bg-gray-700/50 p-3 rounded-lg border-l-4 border-yellow-500 space-y-2';
                item.innerHTML = `
                    <p class="text-sm text-gray-400">Request ID: <span class="font-mono text-xs text-yellow-400">${req.id}</span></p>
                    <p class="text-lg font-bold text-white">${req.points_requested.toLocaleString()} Points</p>
                    <p class="text-sm text-gray-300">User: <span class="font-semibold text-primary-green">${req.username} (${req.user_telegram_id})</span></p>
                    <p class="text-sm text-gray-300">Account: <span class="font-semibold">${details.account}</span></p>
                    <div class="flex space-x-3 mt-3">
                        <button onclick="handleAdminAction(${req.id}, 'Approve', this)" class="flex-1 py-2 text-sm bg-green-600 rounded-lg hover:bg-green-700 transition font-semibold">Approve</button>
                        <button onclick="handleAdminAction(${req.id}, 'Reject', this)" class="flex-1 py-2 text-sm bg-red-600 rounded-lg hover:bg-red-700 transition font-semibold">Reject</button>
                    </div>
                `;
                withdrawalList.appendChild(item);
            });
        }
        
        // ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ (Approve/Reject)
        async function handleAdminAction(requestId, action, button) {
            button.disabled = true;
            button.textContent = 'Processing...';

            try {
                const response = await fetch(`${BASE_URL}/api/admin/update_withdrawal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        adminId: TELEGRAM_ID, // ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ID ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                        requestId: requestId,
                        action: action
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage("‡¶∏‡¶´‡¶≤!", `‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ${requestId} ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ${action} ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, false);
                    loadWithdrawals(); // ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ
                    loadUserData(false); // ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶∞‡¶ø‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶≤‡ßá ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ø‡¶æ‡¶¨‡ßá)
                } else {
                    showMessage("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", data.message || `‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${action}`, true);
                }

            } catch (error) {
                console.error('Admin action error:', error);
                showMessage("‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", `‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡•§`, true);
            } finally {
                // ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶è‡¶Æ‡¶®‡¶ø‡¶§‡ßá‡¶á ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
            }
        }


        // ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡¶∞‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶®‡¶æ
        window.onload = () => {
            loadAppConfig(); // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶ì ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            loadUserData(true); // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
        };
    </script>
</body>
    </html>
