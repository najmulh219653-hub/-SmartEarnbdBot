<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EarnQuick üéØ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='10070523' data-sdk='show_10070523'></script>
    
    <style>
        /* ------------------ COMMON STYLES ------------------ */
        :root { --primary-blue: #234d7d; --green-earn: #4CAF50; --orange-withdraw: #FF9800; --secondary-bg: #f5f7f9; --text-color: #333; }
        body { font-family: 'Arial', sans-serif; background-color: var(--secondary-bg); color: var(--text-color); margin: 0; padding: 0; touch-action: manipulation; }
        .container { padding: 0; max-width: 600px; margin: auto; background-color: white; min-height: 100vh; }

        /* ------------------ USER UI STYLES ------------------ */
        .header-container { background: linear-gradient(135deg, #1d2b64, #f8cdda); color: white; padding: 20px 0; text-align: center; overflow: hidden; border-radius: 0 0 15px 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); margin-bottom: 20px; position: relative; animation: fadeIn 1s ease-out; }
        .header-container::before { content: ''; position: absolute; top: 0; left: 0; width: 300%; height: 100%; background: repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.1) 10px, transparent 10px, transparent 20px); animation: flowBg 60s linear infinite; opacity: 0.15; z-index: 1; }
        @keyframes flowBg { 0% { transform: translate(0, 0); } 100% { transform: translate(-200%, 0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .headline-text { position: relative; z-index: 2; font-size: 1.5em; font-weight: bold; margin-bottom: 5px; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); }
        .referral-info { position: relative; z-index: 2; font-size: 0.9em; opacity: 0.8; }
        .balance-card { background: none; color: white; padding: 0; text-align: center; margin-bottom: 10px; }
        .points-display { font-size: 2.5em; font-weight: 900; margin-top: 5px; color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.8); display: block; }
        .balance-card p { margin: 0; font-size: 14px; opacity: 0.9; }

        #ad-button, #withdraw-button { border: none; padding: 15px 20px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; width: 90%; margin: 10px 5%; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        #ad-button { background-color: var(--green-earn); color: white; }
        #withdraw-button { background-color: var(--orange-withdraw); color: white; }
        #ad-button:disabled { background-color: #ccc; cursor: not-allowed; }

        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px 10px; border-top: 1px solid #eee; margin-top: 20px; }
        .menu-btn-container { text-align: center; }
        .menu-btn { background: none; border: none; color: var(--primary-blue); font-size: 14px; cursor: pointer; display: block; width: 100%; padding: 5px 0; }
        .menu-icon { font-size: 24px; margin-bottom: 5px; display: block; }
        .ad-container { text-align: center; background-color: #fff; overflow: hidden; margin-bottom: 10px; min-height: 90px; } 
        #status-message { text-align: center; padding: 10px; color: var(--primary-blue); font-weight: bold; }
        
        /* ------------------ ADMIN UI STYLES ------------------ */
        .admin-view { padding: 20px; background-color: #f4f7f6; min-height: 100vh; }
        .admin-view h1 { color: #234d7d; text-align: center; margin-bottom: 20px; }
        .summary { display: flex; justify-content: space-around; margin-bottom: 20px; flex-wrap: wrap; }
        .summary-card { padding: 10px 20px; margin: 5px; background-color: #e0f7fa; border-left: 5px solid #00bcd4; border-radius: 4px; text-align: center; min-width: 150px; }
        #searchInput { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; font-size: 14px; }
        th { background-color: #234d7d; color: white; cursor: pointer; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        #admin-status { text-align: center; color: red; font-weight: bold; padding: 10px; }
    </style>
</head>
<body>
    
    <div class="user-view">
        <div class="header-container">
            <div class="headline-text">üí∞ EarnQuick Official - ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! üí∞</div>
            <div class="referral-info">
                ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü: <span id="referral-count-display">0</span> ‡¶ú‡¶® | 
                ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏: <span id="referral-bonus-display">250</span> ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü
            </div>
            
            <div class="balance-card">
                <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                <span class="points-display" id="total-points">0</span>
                <p>‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®: <span id="min-withdraw-display">10000</span> ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü = 40 ‡¶ü‡¶æ‡¶ï‡¶æ</p>
            </div>
        </div>
        
        <div class="ad-container">
            <script type="text/javascript">
                var atOptions = {
                    'key' : '00605022df81b880d400151bfc7c2185',
                    'format' : 'iframe',
                    'height' : 90,
                    'width' : 728,
                    'params' : {}
                };
                document.write('<scr' + 'ipt type="text/javascript" src="//enabledetective.com/00605022df81b880d400151bfc7c2185/invoke.js"></scr' + 'ipt>');
            </script>
        </div>

        <button id="ad-button" disabled>‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç <span id="points-per-ad-display">5</span> ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button id="withdraw-button" onclick="openWithdrawal()">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® (Withdraw)</button>
        <p id="status-message">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>

        <div class="menu-grid">
            <div class="menu-btn-container" onclick="openReferral()"><span class="menu-icon">üîó</span><button class="menu-btn">‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
            <div class="menu-btn-container" onclick="openHistory()"><span class="menu-icon">üßæ</span><button class="menu-btn">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</button></div>
            <div class="menu-btn-container"><span class="menu-icon">üìû</span><button class="menu-btn" onclick="openSupport()">‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü</button></div>
        </div>
        
        <div class="ad-container" style="margin-top: 20px;">
            <script type="text/javascript">
                var atOptions = {
                    'key' : '00605022df81b880d400151bfc7c2185',
                    'format' : 'iframe',
                    'height' : 90,
                    'width' : 728,
                    'params' : {}
                };
                document.write('<scr' + 'ipt type="text/javascript" src="//enabledetective.com/00605022df81b880d400151bfc7c2185/invoke.js"></scr' + 'ipt>');
            </script>
        </div>
    </div>

    <div class="admin-view" style="display:none;">
        <h1>EarnQuick üìä ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1>
        <div id="summary" class="summary"></div>
        <div id="admin-status">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
        <table>
            <thead>
                <tr>
                    <th onclick="sortTable(0)">ID (User)</th>
                    <th onclick="sortTable(1)">‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü (Points)</th>
                    <th onclick="sortTable(2)">‡¶ü‡¶æ‡¶ï‡¶æ (Taka)</th>
                    <th onclick="sortTable(3)">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ (Refs)</th>
                    <th onclick="sortTable(4)">‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® (Reqs)</th>
                    <th onclick="sortTable(5)">‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
            </tbody>
        </table>
    </div>
    
    <script>
        // --- ‡¶ï‡¶®‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü‡¶∏ ---
        const SERVER_URL = 'https://smartearnbdbot.onrender.com'; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Render ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ URL
        const BOT_USERNAME = "@EarnQuick_Official_bot";
        
        // ‚òÖ‚òÖ‚òÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ü ‡¶ï‡¶®‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü‡¶∏ ‚òÖ‚òÖ‚òÖ
        const POINTS_PER_AD = 5; 
        const REFERRAL_BONUS_POINTS = 250; 
        const MIN_WITHDRAW_POINTS = 10000; 
        const POINTS_PER_TAKA = 250; // ‡ß®‡ß´‡ß¶ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡ßá ‡ßß ‡¶ü‡¶æ‡¶ï‡¶æ

        let telegramUserId = null;
        let currentPoints = 0;
        let isAdminView = false;
        
        // --- ‡¶á‡¶â‡¶ü‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø ‡¶ì API ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
        function getQueryVariable(variable) {
            const query = window.location.search.substring(1);
            const vars = query.split('&');
            for (let i = 0; i < vars.length; i++) {
                const pair = vars[i].split('=');
                if (pair[0] === variable) {
                    return pair[1];
                }
            }
            return false;
        }

        function loadTelegramUser() {
            try {
                const user = Telegram.WebApp.initDataUnsafe.user;
                if (user && user.id) {
                    telegramUserId = user.id.toString();
                    return true;
                }
                document.getElementById('status-message').innerText = "‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®‡•§";
                return false;
            } catch (e) {
                document.getElementById('status-message').innerText = "‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ SDK ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§";
                return false;
            }
        }
        
        function updateUI() { 
            document.getElementById('total-points').innerText = currentPoints.toLocaleString(); 
            document.getElementById('points-per-ad-display').innerText = POINTS_PER_AD; 
            document.getElementById('referral-bonus-display').innerText = REFERRAL_BONUS_POINTS;
            document.getElementById('min-withdraw-display').innerText = MIN_WITHDRAW_POINTS;
        }
        
        async function fetchUserData() {
             document.getElementById('status-message').innerText = "‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
             try {
                 const response = await fetch(`${SERVER_URL}/api/user/${telegramUserId}`);
                 
                 if (response.ok) {
                     const data = await response.json();
                     currentPoints = data.earned_points;
                     document.getElementById('referral-count-display').innerText = data.referral_count;
                     updateUI();
                     document.getElementById('status-message').innerText = "‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶ö‡¶≤ ‡¶Ü‡¶õ‡ßá‡¶®‡•§";
                     document.getElementById('ad-button').disabled = false;
                 } else {
                     document.getElementById('status-message').innerText = `‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${response.status}. ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶®‡•§`;
                     Telegram.WebApp.showAlert(`‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${response.status}. ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶®‡•§`);
                 }
             } catch (error) {
                 console.error('Fetch Error:', error);
                 document.getElementById('status-message').innerText = "‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶®‡•§ (‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ)"; 
                 Telegram.WebApp.showAlert("‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ URL ‡¶¨‡¶æ CORS ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
             }
        }

        async function addPointsToUser(pointsToAdd) {
             if (!telegramUserId) return;
             document.getElementById('status-message').innerText = "‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
             document.getElementById('ad-button').disabled = true;
             
             try {
                const response = await fetch(`${SERVER_URL}/api/add_points`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: telegramUserId, points: pointsToAdd })
                });
                const data = await response.json();

                if (data.success) {
                    currentPoints = data.new_points;
                    updateUI();
                    document.getElementById('status-message').innerText = `${pointsToAdd} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶Æ‡ßã‡¶ü: ${currentPoints.toLocaleString()}`;
                } else {
                    document.getElementById('status-message').innerText = `‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø: ${data.message || 'Unknown error'}`;
                    Telegram.WebApp.showAlert("‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
                }
             } catch (error) {
                document.getElementById('status-message').innerText = "‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
                Telegram.WebApp.showAlert("‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
             } finally {
                setTimeout(() => { document.getElementById('ad-button').disabled = false; }, 5000); 
             }
        }

        // --- ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶ì ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§) ---
        function onAdRewardSuccess() { addPointsToUser(POINTS_PER_AD); }
        function handleAdButtonClick() {
            if (!telegramUserId) return;
            document.getElementById('status-message').innerText = "‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...";
            document.getElementById('ad-button').disabled = true;
            const adFunction = window.show_10070523; 
            const ymid = telegramUserId; 

            if (typeof adFunction === 'function') {
                adFunction({ ymid: ymid })
                .then(() => { onAdRewardSuccess(); })
                .catch((error) => {
                    document.getElementById('status-message').innerText = "‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶°/‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                    setTimeout(() => { document.getElementById('ad-button').disabled = false; }, 3000); 
                });
            } else {
                document.getElementById('status-message').innerText = "‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø! ‡ß´ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                setTimeout(() => { document.getElementById('ad-button').disabled = false; }, 5000); 
            }
        }
        
        async function openWithdrawal() {
            if (!telegramUserId) return;

            if (currentPoints < MIN_WITHDRAW_POINTS) {
                const equivalentTaka = (MIN_WITHDRAW_POINTS/POINTS_PER_TAKA).toFixed(0);
                Telegram.WebApp.showAlert(`‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§! ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ${MIN_WITHDRAW_POINTS} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü (‡ß≥${equivalentTaka}) ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü: ${currentPoints.toLocaleString()}`);
                return;
            }

            const withdrawAmount = MIN_WITHDRAW_POINTS; 
            const equivalentTaka = (withdrawAmount / POINTS_PER_TAKA).toFixed(0); 
            
            Telegram.WebApp.showPopup({
                title: "‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®",
                message: `**${withdrawAmount.toLocaleString()} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü = ‡ß≥${equivalentTaka} ‡¶ü‡¶æ‡¶ï‡¶æ**‡•§\n‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶≤‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:`,
                buttons: [
                    { id: 'bKash', text: '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂' },
                    { id: 'Nagad', text: '‡¶®‡¶ó‡¶¶' },
                    { id: 'cancel', text: '‡¶¨‡¶æ‡¶§‡¶ø‡¶≤' }
                ]
            }, async function(paymentMethod) {
                if (paymentMethod === 'cancel' || !paymentMethod) return;
                const paymentNumber = prompt(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${paymentMethod} ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 01xxxxxxxxx):`);
                if (!paymentNumber || paymentNumber.length < 10) {
                    Telegram.WebApp.showAlert("‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                    return;
                }
                
                document.getElementById('status-message').innerText = `‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`;
                document.getElementById('withdraw-button').disabled = true; 
                
                try {
                    const response = await fetch(`${SERVER_URL}/api/withdraw`, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: telegramUserId,
                            pointsToWithdraw: withdrawAmount,
                            paymentMethod: paymentMethod,
                            paymentNumber: paymentNumber
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        currentPoints = data.new_points; 
                        updateUI();
                        document.getElementById('status-message').innerText = `‚úÖ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Æ‡ßã‡¶ü: ${currentPoints.toLocaleString()} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü‡•§`;
                        Telegram.WebApp.showAlert("‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∏‡¶´‡¶≤! ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§");
                    } else {
                        document.getElementById('status-message').innerText = `‚ùå ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${data.message || 'Unknown error'}`; 
                        Telegram.WebApp.showAlert(`‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${data.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    document.getElementById('status-message').innerText = "‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
                    Telegram.WebApp.showAlert("‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
                } finally {
                    document.getElementById('withdraw-button').disabled = false; 
                }
            });
        }

        function openReferral() {
            if (!telegramUserId) return;
            const referralLink = `https://t.me/${BOT_USERNAME}?start=${telegramUserId}`;
            const message = `üéâ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï:\n\nüîó ${referralLink}\n\nüî• ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∏‡¶´‡¶≤ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡¶æ‡¶¨‡ßá‡¶®: ${REFERRAL_BONUS_POINTS} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡•§`;
            
            Telegram.WebApp.showPopup({
                title: "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï",
                message: message,
                buttons: [{id: 'copy', text: '‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®'}, {id: 'close', text: '‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®'}]
            }, function(buttonId) {
                if (buttonId === 'copy') {
                    navigator.clipboard.writeText(referralLink).then(() => { Telegram.WebApp.showAlert('‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!'); });
                }
            });
        }
        
        function openSupport() { Telegram.WebApp.showAlert(`üìû ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ü‡¶ø‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:\n\n‡¶´‡ßã‡¶®: 01913621510\n‡¶á‡¶Æ‡ßá‡¶á‡¶≤: najmulh219653@gmail.com`); }
        function openHistory() { Telegram.WebApp.showAlert("‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§"); }


        // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶≤‡¶ú‡¶ø‡¶ï (admin.html ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶®‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá) ---
        let userData = []; 

        async function fetchAdminData() {
            try {
                const statusElement = document.getElementById('admin-status');
                statusElement.innerText = "‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
                
                const response = await fetch(`${SERVER_URL}/api/admin/all_users`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success && data.users) {
                    userData = data.users;
                    renderTable(userData);
                    renderSummary(userData);
                    statusElement.innerText = `‚úÖ ‡¶Æ‡ßã‡¶ü ‡¶á‡¶â‡¶ú‡¶æ‡¶∞: ${userData.length} ‡¶ú‡¶®‡•§`;
                } else {
                    statusElement.innerText = "‚ùå ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶≠‡ßÅ‡¶≤‡•§";
                }
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('admin-status').innerText = `‚ùå ‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶¨‡¶æ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${error.message}`;
            }
        }

        function renderSummary(users) {
            const totalPoints = users.reduce((sum, user) => sum + user.points, 0);
            const totalTaka = users.reduce((sum, user) => sum + parseFloat(user.taka), 0);
            const totalReferrals = users.reduce((sum, user) => sum + user.referrals, 0);
            const totalWithdraws = users.reduce((sum, user) => sum + user.withdraw_requests, 0);

            const summaryHtml = `
                <div class="summary-card">‡¶Æ‡ßã‡¶ü ‡¶á‡¶â‡¶ú‡¶æ‡¶∞: <strong>${users.length}</strong></div>
                <div class="summary-card">‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤: <strong>${totalReferrals}</strong></div>
                <div class="summary-card">‡¶Æ‡ßã‡¶ü ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü: <strong>${totalPoints.toLocaleString()}</strong></div>
                <div class="summary-card">‡¶Æ‡ßã‡¶ü ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß: <strong>${totalWithdraws}</strong></div>
            `;
            document.getElementById('summary').innerHTML = summaryHtml;
        }

        function renderTable(users) {
            const tableBody = document.getElementById('userTableBody');
            tableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = user.id;
                row.insertCell().textContent = user.points.toLocaleString();
                row.insertCell().textContent = user.taka;
                row.insertCell().textContent = user.referrals;
                row.insertCell().textContent = user.withdraw_requests;
                row.insertCell().textContent = user.joined;
            });
        }
        
        function filterTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase();
            
            const filteredUsers = userData.filter(user => {
                const idMatch = user.id.toUpperCase().includes(filter);
                const refMatch = user.referrals.toString().includes(filter);
                return idMatch || refMatch;
            });

            renderTable(filteredUsers);
        }

        let sortDirection = {};
        function sortTable(n) {
            let table = document.getElementById("userTableBody");
            let rows = Array.from(table.rows);
            const isNumeric = [1, 2, 3, 4].includes(n);
            const currentDirection = sortDirection[n] === 'asc' ? 'desc' : 'asc';
            
            rows.sort((rowA, rowB) => {
                let x = rowA.cells[n].textContent;
                let y = rowB.cells[n].textContent;

                if (isNumeric) {
                    x = parseFloat(x.replace(/,/g, ''));
                    y = parseFloat(y.replace(/,/g, ''));
                } else {
                    x = x.toLowerCase();
                    y = y.toLowerCase();
                }

                if (currentDirection === 'asc') {
                    return x > y ? 1 : -1;
                } else {
                    return x < y ? 1 : -1;
                }
            });

            table.innerHTML = '';
            rows.forEach(row => table.appendChild(row));
            sortDirection[n] = currentDirection;
        }

        // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ---
        document.addEventListener('DOMContentLoaded', () => {
            isAdminView = getQueryVariable('view') === 'admin';

            if (isAdminView) {
                // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≠‡¶ø‡¶â
                document.querySelector('.user-view').style.display = 'none';
                document.querySelector('.admin-view').style.display = 'block';
                fetchAdminData();
            } else {
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≠‡¶ø‡¶â
                document.querySelector('.user-view').style.display = 'block';
                document.querySelector('.admin-view').style.display = 'none';
                if (loadTelegramUser()) {
                    fetchUserData();
                    const adButton = document.getElementById('ad-button');
                    if (adButton) {
                        adButton.addEventListener('click', handleAdButtonClick);
                    }
                }
            }

            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        });
    </script>
</body>
</html>
